# A prefix command applied to commands that manipulate the destination
# directories.  Left as null to prevent surprises for people who haven't
# read this Makefile before using it, but often set to "sudo".
SUDO=

# The name by which the update-passtokens script can be executed.
# This will probably have to be specified, as update-passtokens is not
# usually installed.
# It is available in the source as sipXcommserverLib/doc/update-passtokens.
UPDATE_PASSTOKENS=update-passtokens

# The names of the destination directories.
# These values are the defaults for RPM installation, but can be retargeted.
# See http://www.sipfoundry.org/sipX/doc/filesystem.html.
# Note that changing these values is not completely supported yet --
# some of the installed files would need to be adjusted.
SIPX_USER=sipx
SIPX_BINDIR=/usr/bin
SIPX_CONFDIR=/etc/sipxpbx
SIPX_DATADIR=/var/sipxdata
SIPX_LIBDIR=/usr/lib
SIPX_LOGDIR=/var/log/sipxpbx
SIPX_RUNDIR=/var/run/sipxpbx
HTTP_ROOTDIR=/usr/share/www/doc
HTTP_MODULEDIR=/etc/httpd/modules

# The names of all the installed files, derived from the files in
# the install subdirectories.
CONFIG_FILES=$(subst sipx_confdir,$(SIPX_CONFDIR),$(filter-out %~,$(wildcard sipx_confdir/*)))
DOC_FILES=$(subst http_rootdir,$(HTTP_ROOTDIR),$(filter-out %~,$(wildcard http_rootdir/*)))
SIPDB_FILES=$(subst sipx_dbdir,$(SIPX_DATADIR)/sipdb,$(filter-out %~,$(wildcard sipx_dbdir/*)))

CONFIG_FILES_EDITED=$(subst .pre,,$(subst sipx_confdir,$(SIPX_CONFDIR),$(filter-out %~,$(wildcard sipx_confdir/*.pre))))
DOC_FILES_EDITED=$(subst .pre,,$(subst http_rootdir,$(HTTP_ROOTDIR),$(filter-out %~,$(wildcard http_rootdir/*.pre))))
SIPDB_FILES_EDITED=$(subst .pre,,$(subst sipx_dbdir,$(SIPX_DATADIR)/sipdb,$(filter-out %~,$(wildcard sipx_dbdir/*.pre))))

install: debug $(CONFIG_FILES) $(DOC_FILES) $(SIPDB_FILES) $(CONFIG_FILES_EDITED) $(DOC_FILES_EDITED) $(SIBDB_FILES_EDITED) $(SIPX_DATADIR)/sipdb/credential.xml

debug:
	@ : echo CONFIG_FILES=$(CONFIG_FILES)
	@ : echo DOC_FILES=$(DOC_FILES)
	@ : echo SIPDB_FILES=$(SIPDB_FILES)
	@ : echo DOC_FILES_EDITED=$(DOC_FILES_EDITED) 
	@ : echo CONFIG_FILES_EDITED=$(CONFIG_FILES_EDITED)
	@ : echo SIPDB_FILES_EDITED=$(SIPDB_FILES_EDITED)

$(CONFIG_FILES): $(SIPX_CONFDIR)/%: sipx_confdir/%
	$(SUDO) cp $< $@

$(DOC_FILES): $(HTTP_ROOTDIR)/%: http_rootdir/%
	$(SUDO) cp $< $@

$(SIPDB_FILES): $(SIPX_DATADIR)/sipdb/%: sipx_dbdir/%
	$(SUDO) cp $< $@

$(SIPX_CONFDIR)/config.defs: $(SIPX_CONFDIR)/config.defs.in
	$(SUDO) sh -c \
		"sed \
			-e 's!@SIPX_USER@!$(SIPX_USER)!g' \
			-e 's!@SIPX_BINDIR@!$(SIPX_BINDIR)!g' \
			-e 's!@SIPX_CONFDIR@!$(SIPX_CONFDIR)!g' \
			-e 's!@SIPX_DATADIR@!$(SIPX_DATADIR)!g' \
			-e 's!@SIPX_LIBDIR@!$(SIPX_LIBDIR)!g' \
			-e 's!@SIPX_LOGDIR@!$(SIPX_LOGDIR)!g' \
			-e 's!@SIPX_RUNDIR@!$(SIPX_RUNDIR)!g' \
			-e 's!@HTTP_ROOTDIR@!$(HTTP_ROOTDIR)!g' \
			-e 's!@HTTP_MODULEDIR@!$(HTTP_MODULEDIR)!g' \
		<$< >$@"

$(CONFIG_FILES_EDITED) $(DOC_FILES_EDITED) $(SIPDB_FILES_EDITED): %: %.pre $(SIPX_CONFDIR)/config.defs
	. $(SIPX_CONFDIR)/config.defs ;\
	$(SUDO) sh -c \
		"sed \
			-e 's!@SIPXCHANGE_DOMAIN_NAME@!$$SIPXCHANGE_DOMAIN_NAME!g' \
			-e 's!@HOSTNAME@!$$MY_FULL_HOSTNAME!g' \
			-e 's!@SIPX_USER@!$(SIPX_USER)!g' \
			-e 's!@SIPX_BINDIR@!$(SIPX_BINDIR)!g' \
			-e 's!@SIPX_CONFDIR@!$(SIPX_CONFDIR)!g' \
			-e 's!@SIPX_DATADIR@!$(SIPX_DATADIR)!g' \
			-e 's!@SIPX_LIBDIR@!$(SIPX_LIBDIR)!g' \
			-e 's!@SIPX_LOGDIR@!$(SIPX_LOGDIR)!g' \
			-e 's!@SIPX_RUNDIR@!$(SIPX_RUNDIR)!g' \
			-e 's!@HTTP_ROOTDIR@!$(HTTP_ROOTDIR)!g' \
			-e 's!@HTTP_MODULEDIR@!$(HTTP_MODULEDIR)!g' \
		<$< >$@"

$(SIPX_DATADIR)/sipdb/credential.xml: $(SIPX_DATADIR)/sipdb/credential.xml.in $(SIPX_CONFDIR)/config.defs
	$(SUDO) sh -c \
		"yes 1234 | $(UPDATE_PASSTOKENS) $< $@"
	@echo
