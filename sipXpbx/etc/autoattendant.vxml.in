<?xml version="1.0"?>
<vxml version="2.0" application="../vm_vxml/root.vxml">
    <!-- Autoattendant main menu -->
   <!-- This variable is common to both the forms.
    It is filled when the user selects the auto attendant 
    option that should result in a transfer. This variable is
    filled with the destination extension.
    This is used by the form 'transferform'.
   -->
   <var name="transferextn"/>
    <form id="aa">
        <property name="interdigittimeout" value="3s" />
        <property name="timeout" value="7s" />

        <!-- Parameters passed in from the calling subroutine -->
        <var name="from" />
        <var name="mediaserverurl" />
        <var name="securemediaserverurl" />
        <var name="action" />
        <var name="extension" />
        <var name="systemgreetingurl" />
        <var name="autoattendantprompturl" />

        <!-- Play the autoattendant main menu -->
        <field name="menu" type="digits?minlength=1;maxlength=${EXTENSION_LENGTH}">
            <prompt>
                <audio expr="systemgreetingurl" />
            </prompt>
            <prompt cond="autoattendantprompturl != '-1'">
                <audio expr="autoattendantprompturl" />
            </prompt>
            <filled>
                <if cond="menu=='0'" >
                    <assign name="operation" expr="aa_option_0" />
                    <assign name="extension" expr="aa_option_0_extn" />
                    <goto nextitem="menuaction" />
                <elseif cond="menu=='1'" />
                    <assign name="operation" expr="aa_option_1" />
                    <assign name="extension" expr="aa_option_1_extn" />
                    <goto nextitem="menuaction" />
                <elseif cond="menu=='2'" />
                    <assign name="operation" expr="aa_option_2" />
                    <assign name="extension" expr="aa_option_2_extn" />
                    <goto nextitem="menuaction" />
                <elseif cond="menu=='3'" />
                    <assign name="operation" expr="aa_option_3" />
                    <assign name="extension" expr="aa_option_3_extn" />
                    <goto nextitem="menuaction" />
                <elseif cond="menu=='4'" />
                    <assign name="operation" expr="aa_option_4" />
                    <assign name="extension" expr="aa_option_4_extn" />
                    <goto nextitem="menuaction" />
                <elseif cond="menu=='5'" />
                    <assign name="operation" expr="aa_option_5" />
                    <assign name="extension" expr="aa_option_5_extn" />
                    <goto nextitem="menuaction" />
                <elseif cond="menu=='6'" />
                    <assign name="operation" expr="aa_option_6" />
                    <assign name="extension" expr="aa_option_6_extn" />
                    <goto nextitem="menuaction" />
                <elseif cond="menu=='7'" />
                    <assign name="operation" expr="aa_option_7" />
                    <assign name="extension" expr="aa_option_7_extn" />
                    <goto nextitem="menuaction" />
                <elseif cond="menu=='8'" />
                    <assign name="operation" expr="aa_option_8" />
                    <assign name="extension" expr="aa_option_8_extn" />
                    <goto nextitem="menuaction" />
                <elseif cond="menu=='9'" />
                    <assign name="operation" expr="aa_option_9" />
                    <assign name="extension" expr="aa_option_9_extn" />
                    <goto nextitem="menuaction" />
                <elseif cond="menu=='*'" />
                    <assign name="operation" expr="aa_option_star" />
                    <assign name="extension" expr="aa_option_star_extn" />
                    <goto nextitem="menuaction" />
                <elseif cond="menu=='#'" />
                    <assign name="action" expr="'retrieve'" />
                    <assign name="operation" expr="aa_option_pound" />
                    <assign name="extension" expr="aa_option_pound_extn" />
                    <goto nextitem="menuaction" />
                <else />
                     <assign name="action" expr="'transfer'" />
                    <assign name="extension" expr="menu" />
                    <goto nextitem="transfertoextn"/>
                </if>
            </filled>
            <noinput count="1">
                <reprompt/>
            </noinput>
            <noinput count="2">
                <reprompt/>
            </noinput>
            <noinput count="3">
                <prompt bargein="false">
                    <audio expr="mediaserverurl + promptsalias + 'thankyou_goodbye.wav'" />
                </prompt>
                <disconnect />
            </noinput>
        </field>

        <block name="menuaction">
            <if cond="operation == 'dialbyname'">
                <goto nextitem="dialbyname"/>
            <elseif cond="operation == 'voicemail'" />
                <goto nextitem="retrieve" />
            <elseif cond="operation == 'transfertoextension'" />
                <prompt bargein="false">
                    <audio expr="mediaserverurl + promptsalias + 'please_hold.wav'" />
                </prompt>
                <assign name="transferextn" expr="extension" />
                <goto next="#transferform" />
            <elseif cond="operation == 'hangup'" />
                <prompt bargein="false">
                    <audio expr="mediaserverurl + promptsalias + 'thankyou_goodbye.wav'" />
                </prompt>
                <disconnect />
           <elseif cond="operation == 'repeatprompt'" />
                <clear namelist="menu" />
                <goto nextitem="menu" />
            <else/>
                <prompt>
                    <audio expr="mediaserverurl + promptsalias + 'invalid_entry_try_again.wav'" />
                </prompt>
                <clear namelist="menu" />
                <goto nextitem="menu" />
            </if>
        </block>

        <subdialog name="transfertoextn" cond="operation == 'transfertoextension'" srcexpr="securemediaserverurl + cgiurl" namelist="action extension">
            <filled>
                <if cond="transfertoextn.result=='invalidextn'">
                    <audio expr="mediaserverurl + promptsalias + 'extn_invalid.wav'" />
                    <clear namelist="menu" />
                    <goto nextitem="menu" />
                <elseif cond="transfertoextn.result=='failed'"/>
                    <prompt>Transfer failed.</prompt>
                    <clear namelist="menu" />
                    <goto nextitem="menu" />
                <else />
                    <prompt>Transfer ended.</prompt>
                    <return />
                </if>
            </filled>
        </subdialog>

        <subdialog name="dialbyname" cond="operation == 'dialbyname'" srcexpr="securemediaserverurl + dialbynameurl">
            <param name="from" expr="from"/>
            <param name="mediaserverurl" expr="mediaserverurl"/>
            <param name="securemediaserverurl" expr="securemediaserverurl" />
            <param name="fromdeposit" expr="'no'" />
            <filled>
                <if cond="dialbyname.result=='success'">
                    <clear namelist="menu" />
                    <goto nextitem="menu" />
                <elseif cond="dialbyname.result=='failed'"/>
                    <goto nextitem="dialbyname"/>
                <elseif cond="dialbyname.result=='quit'"/>
                    <clear namelist="menu" />
                    <goto nextitem="menu"/>
                </if>
            </filled>
        </subdialog>

        <subdialog name="retrieve" cond="operation == 'voicemail'" srcexpr="securemediaserverurl + cgiurl" namelist="action from">
            <filled>
                <return />
            </filled>
        </subdialog>

    </form>

    <form id="transferform">
        <transfer name="extntranfer" destexpr="transferextn" />
    </form>
</vxml>
