#!/bin/sh
##
##  install-ssl-keystore.sh - generate SSL keystore in PKCS12 format
##  AND installs this into JBoss 2.2.4 for sipXconfig Web Admin UI
##  will have to correct SSL Certificate for web browsers.
##
##  Copyright (c) 2004 SIPfoundry, Inc.
##  License by SIPfoundry under the LGPL license.
##  
##  Copyright (c) 2004 Pingtel Corp.
##  Licensed to SIPfoundry under a Contributor Agreement.
##
##  Derived from:
##  CCA -- Trivial Client CA management for testing purposes
##  Copyright (c) 1998-2001 Ralf S. Engelschall, All Rights Reserved. 
##

myName=`basename $0`
myDir=`dirname $0`

# password can be changed but it must match what's in
# @tomcat.home@/../jboss/conf/catalina/jboss.jcml
password=changeit

#   external tools
openssl="/usr/bin/openssl"

# assumes gen-keys doesn't increment, as of 01/05 it didn't
# if this becomes untrue, this line should be
#   server="server-"`cat ca.ser`
# doing so now causes ca.ser=02 which is incorrect
server="server-01"

caname="`$openssl x509 -noout -text -in ca.crt |\
         grep Subject: | sed -e 's;.*CN=;;' -e 's;/Em.*;;'`"
servername="`$openssl x509 -noout -text -in $server.crt |\
           grep Subject: | sed -e 's;.*CN=;;' -e 's;/Em.*;;'`"
echo "Assembling PKCS#12 package"
$openssl pkcs12 -export -in $server.crt -inkey $server.key -certfile ca.crt -name "$servername" -caname "$caname" -out $server.p12 -password pass:$password || exit -1
cp $server.p12 @tomcat.home@/conf/ssl.pkcs12

${PAGER:-more} <<EOF
______________________________________________________________________
Results:

PKCS12 Keystore 

   local generated keystore:   $server.p12
   installed keystore:         @tomcat.home@/conf/ssl.pkcs12

If you generate or receive new private SSL key or generate new Certificate
you must rerun this script to install certificate into Web Admin UI. If you
do not, user's will simply be presented with old SSL Certificate in their
web browsers.

EOF
