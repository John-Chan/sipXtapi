#!/bin/sh
##
## install-cert.sh
##
##  Copyright (c) 2004 SIPfoundry, Inc.
##  License by SIPfoundry under the LGPL license.
##  
##  Copyright (c) 2004 Pingtel Corp.
##  Licensed to SIPfoundry under a Contributor Agreement.
##

Action=INSTALL
InstallCA=TRUE
Basename=""

while [ $# -ne 0 ]
do
    case ${1} in
        ##
        ## handle a flag with no value followiing
        ##
        -s|--server-only)
            InstallCA=FALSE
            ;;

        ##
        ## handle the 'end of options' marker
        ##
        --)
            ;;

        ##
        ## handle an unknown switch
        ##
        -*)
            Action=USAGE
            break
            ;;

        *)
            if [ -z "${Basename}" ]
            then
                Basename=${1}
            else
                echo "Too many arguments supplied: $@" 1>&2
                Action=USAGE
                break
            fi
            ;;
    esac           

    shift # always consume 1
done


if [ "${Action}" = "USAGE" -o -z "${Basename}" ]
then
    cat <<EOF
Usage:
   install-cert.sh [--server-only] <file-base>

   The file-base specifies the base name of the .key and .crt files
   generated by the self-certify script.

EOF
    exit 1
fi

@bindir@/ssl-cert/check-cert.sh --verbose $Basename.crt 

test -d @SIPX_CONFDIR@/ssl \
|| install -m 0700 -o @SIPXPBXUSER@ -d @SIPX_CONFDIR@/ssl \
|| exit 1

install -m 0600 -o @SIPXPBXUSER@ $Basename.crt @SIPX_CONFDIR@/ssl/ssl.crt \
|| exit 1

install -m 0600 -o @SIPXPBXUSER@ $Basename.key @SIPX_CONFDIR@/ssl/ssl.key \
|| exit 1

# install the jboss keystore copy
@bindir@/ssl-cert/install-ssl-keystore.sh @SIPX_CONFDIR@/ssl/ssl \
|| exit 1

if [ $InstallCA = TRUE ]
then
    java=`@bindir@/sipx-config --jdk` || exit 1
    
    cat <<EOF

  You will need to enter your Java keystore password.  The default 
  password should be "changeit".  

  You should answer 'yes' when prompted to trust this certificate.

EOF
    ${java}/bin/keytool -import -keystore ${java}/jre/lib/security/cacerts -file ca.crt

    if [ $? -ne 0 ]
    then
        cat <<EOF

  Certificate installation failed.

  If the error message above indicates that a certificate with the same
  alias is already installed, then do:

${java}/bin/keytool -delete  -keystore ${java}/jre/lib/security/cacerts -alias mykey

  and then rerun the install-cert.sh command.

  If the error message says Permission Denied, then you probably need
  to rerun this script as root.

EOF
        exit 1
    fi
fi

cat <<EOF

  Your sipX SSL security is now configured.

EOF
