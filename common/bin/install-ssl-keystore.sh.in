#!/bin/sh
##
## install-ssl-keystore.sh
##
##  Copyright (c) 2004 SIPfoundry, Inc.
##  License by SIPfoundry under the LGPL license.
##  
##  Copyright (c) 2004 Pingtel Corp.
##  Licensed to SIPfoundry under a Contributor Agreement.
##

Action=INSTALL
Basename=""

while [ $# -ne 0 ]
do
    case ${1} in
        ##
        ## handle the 'end of options' marker
        ##
        --)
            ;;

        ##
        ## handle an unknown switch
        ##
        -*)
            Action=USAGE
            break
            ;;

        *)
            if [ -z "${Basename}" ]
            then
                Basename=${1}
            else
                echo "Too many arguments supplied: $@" 1>&2
                Action=USAGE
                break
            fi
            ;;
    esac           

    shift # always consume 1
done


if [ "${Action}" = "USAGE" -o -z "${Basename}" ]
then
    cat <<EOF
Usage:
   install-ssl-keystore.sh <file-base>

   The file-base specifies the base name of the .key and .crt files
   generated by the self-certify script.

EOF
    exit 1
fi

openssl="/usr/bin/openssl"

# password can be changed but it must match what's in
# @jboss.server@/server/sipx/deploy/jbossweb-tomcat50.sar/server.xml
password="changeit"

servername="`$openssl x509 -noout -text -in $Basename.crt |\
           grep Subject: | sed -e 's;.*CN=;;' -e 's;/Em.*;;'`"
echo "Assembling PKCS#12 package"

$openssl pkcs12 -export -in $Basename.crt -inkey $Basename.key -name "$servername" -out $Basename.p12 -password pass:$password || exit -1

install -m 0600 -o @sipxpbx.user@ -D $Basename.p12 @jboss.server@/conf/ssl.pkcs12 || exit 1

${PAGER:-more} <<EOF
______________________________________________________________________
Results:

PKCS12 Keystore 

   local generated keystore:   $Basename.p12
   installed keystore:         @jboss.server@/conf/ssl.pkcs12

If you generate or receive new private SSL key or generate new Certificate
you must rerun this script to install certificate into Web Admin UI. If you
do not, user's will simply be presented with old SSL Certificate in their
web browsers.

EOF
