#!/bin/sh

# Purpose of this script is to extract an archive, apply a patch, then
# create a new archive with patch applied.

ExitCode=0
TempDir=/tmp

Action=PATCH_TARBALL
while [ x"$1" != x ]
do
    case $1 in

        --help|-h)
        Action=USAGE
        ;;

        *)
        if [ x"$PatchFile" = x ]
        then
	    PatchFile=$1
        elif [ x"$Archive" = x ]
        then
	    Archive=$1
        elif [ x"$PatchedArchive" = x ]
        then
	    PatchedArchive=$1
        else
	    Action=USAGE
            ExitCode=1
            break
        fi
        ;;
     esac

     shift
done

if [ x"$Action" = xPATCH_TARBALL ]
then
    StagingDir=$TempDir/patch-archive.tmp
    if [ -d $StagingDir ]
    then
        rm -rf $StagingDir
    fi

    mkdir -p $StagingDir
    cat $Archive | (cd  $StagingDir > /dev/null; tar -xzf -)
    patch -p0 --directory $StagingDir < $PatchFile
    (cd $StagingDir > /dev/null; tar -czf - *) | cat >  $PatchedArchive 
    rm -rf $StagingDir

elif [ x"$Action" = USAGE ]
then

cat <<USAGE

Usage:

   patch-archive [-h|--help] patchfile from-archive to-archive

Options are:

   --help         This help message

   patchfile      a diff file created from the parent directory of the 
                  archive

                  Example:                       
                     tar -xvzf packagexyz-1.0.13.tar.gz
                     diff -ur packagexyz-1.0.13 package-modified > patchfile

   from-archive  Original tarfile to be patched

   to-archive    Filename of new archive, Will replace with same name.

USAGE

fi

exit $ExitCode
