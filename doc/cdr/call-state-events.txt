

SIPfoundry sipXproxy                                         S. Lawrence
                                                           Pingtel Corp.
                                                        December 7, 2004


               sipXproxy Call State Events Specification


Abstract

   Specifies the Call State Events detected by the sipXauthproxy; these
   can be used to construct Call Detail Records (CDRs) or other
   indications or records of call state.

Table of Contents

   1.  Overview . . . . . . . . . . . . . . . . . . . . . . . . . . .  2
     1.1   Common Elements  . . . . . . . . . . . . . . . . . . . . .  2
   2.  Observer Message . . . . . . . . . . . . . . . . . . . . . . .  3
   3.  Call State Events  . . . . . . . . . . . . . . . . . . . . . .  3
     3.1   Call Request . . . . . . . . . . . . . . . . . . . . . . .  3
     3.2   Call Setup . . . . . . . . . . . . . . . . . . . . . . . .  3
     3.3   Call Failure . . . . . . . . . . . . . . . . . . . . . . .  4
     3.4   Call End . . . . . . . . . . . . . . . . . . . . . . . . .  4
   4.  Call State Event XML Schema  . . . . . . . . . . . . . . . . .  4
       Author's Address . . . . . . . . . . . . . . . . . . . . . . . 10
   A.  Example Call State Events  . . . . . . . . . . . . . . . . . . 10

























Lawrence                                                        [Page 1]

                           Call State Events               December 2004


1.  Overview

   PBX users often require the collection of call information in order
   to validate external billing or create internal charge-back systems.
   Due to the nature of SIP signalling and the disaggregated sipXpbx
   design, a complete record of a call can only be created by observing
   events that occur at different times and in different sipXpbx
   components.  This document specifies the events recorded and which
   component is responsible for producing a record of each.

   The record of each observed event is called a Call State Event.
   Section 3 describes each of the events to be recorded, the component
   responsible for it (called the "Observer"), the SIP request or
   response from which its information is derived, and the information
   it contains.

   The UCT time of events as recorded by each Observer is used to order
   the events, which is in some cases important to determining the
   semantics of the event.  As a result, it is important that all
   Observer clocks are as closely syncronized with each other as
   possible.

   Call State Events are encoded as XML according to the the schema in
   Section 4.

1.1  Common Elements

   All Call State Events have some elements in common; in fact, most of
   each event consists of the common elements.  These common elements
   are:
   <observer> The DNS name of the system that observed the event.
   <obs_seq> The sequence number of this event at the observer.  This is
      used by a collector to detect that events from an observer are
      missing; in a complete record, there are no gaps in the sequence
      numbers.
   <obs_time> The (UCT) time at the observer when this event occured;
      this should be expressed to the millisecond, or as near to that as
      the Observer can measure.
   <call> The call element is a compound element that describes the call
      itself.  Its dialog component contains the key values used to
      determine which events are in the same call, and the full To and
      From header field values for display purposes.
      <dialog> This value is used to correlate the separate events
         (which may even come from different observers) for the same
         call.  A dialog value has three components:






Lawrence                                                        [Page 2]

                           Call State Events               December 2004


         <call_id> The value from the SIP Call-Id header.
         <from_tag> The value from the tag attribute of the SIP From
            header.
         <to_tag> The value from the tag attribute of the SIP To header.
            This element of a dialog is optional, and will not appear in
            all events.
      <from> The full From header field value.
      <to> The full From header field value.
      <via> A Via header value from the event; this element may appear
         more than once - the order is significant.  The Via elements in
         a CSE are ordered such that the first element is the Via value
         added by the message originator.

2.  Observer Message

   XML element name obs_msg
   Triggered by Any change in Observer status.
   Description Carries a status code for the new status and an optional
      arbitrary text message for display purposes.

   The Observer State Event is defined to signal changes in the Observer
   that may be useful to the interpretation of the Call State Events.
   At this writing, only one event is defined: the Restart (obs_status =
   0) event is sent when the Observer starts up.  It is always sent with
   observer sequence number 0 (zero).

3.  Call State Events

3.1  Call Request

   XML element name call_request
   Triggered by A Call Request Event is generated by the sipproxy server
      when an INVITE request is received that does not have a tag
      parameter on the To field value.
   Description Represents an attempt to create a new call.  The
      <contact> element in this event is the calling party Contact
      header field value.

   Note that in the case of a spiral, where aliases and/or redirections
   cause new INVITE messages to be created, the same call generates
   multiple Call Request events.  Since it is possible for these
   different events to be recorded by different observers, the observer
   timestamp (not the observer sequence number) is used to determine the
   original event.

3.2  Call Setup





Lawrence                                                        [Page 3]

                           Call State Events               December 2004


   XML element name call_setup
   Description Indicates acceptance of a call, or acceptance of a
      request to reconfigure a call.  The <contact> element in this
      event is the called party Contact header field value.
   Triggered by Any 2xx response to any INVITE request.

   This event is correlated with a Call Request event by comparing the
   call_id and from_tag values; the to_tag value will not appear in the
   original call_request event, so it is not used.

   Re-invites will appear as cse_setup events, so putting a call on hold
   or renegotiating the codecs during a call (as, for example, when
   another leg is added to a conference) will generate spurious
   cse_setup events.  These duplicates can be detected by detecting
   duplicate dialog ids and using only the one with the lowest observer
   timestamp (obs_time) value; this is the one that actually indicates
   that the call has been set up.

3.3  Call Failure

   XML element name cse_failure
   Description Indicates that at least one leg of a Call Request
      encountered was rejected.
   Triggered by
         Any 5xx or 6xx response to an INVITE request,
         *or* any 4xx response to an INVITE request *except*:
            401 Authentication Required
            407 Proxy Authentication Required
            408 Request timeout

   Depending on the specific failure mode and the retry behaviour of the
   servers and endpoints, there may be more than one Call Failed event
   for a given attempt to create a call; these should all have the same
   dialog ids.  A call state processor can only conclude that all given
   Call Request event ended in failure if there are no Call Setup events
   for it and there are no missing events.

3.4  Call End

   XML element name cse_end
   Description Termination of a successful call.
   Triggered by Any BYE request.

   The Call End event is correlated with a Call Setup event using the
   dialog id.

4.  Call State Event XML Schema




Lawrence                                                        [Page 4]

                           Call State Events               December 2004


   <?xml version='1.0' encoding='iso-8859-1' standalone='yes'?>
   <!DOCTYPE schema [
   <!ENTITY % sip_word "([&lt;&gt;&quot;a-zA-Z0-9.!&#x25;*_+`'~():\/[&#x5d;?{}-]+)">
   <!ENTITY % sip_token "([a-zA-Z0-9.!&#x25;*_+`'~-]+)">
   <!ENTITY % dns_token "[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?">
   ]>
   <!--
       XML Schema for sipX Call State Events
     -->
   <schema
       xmlns:cse='http://www.sipfoundry.org/sipX/schema/xml/cse-01-00'
       targetNamespace='http://www.sipfoundry.org/sipX/schema/xml/cse-01-00'
       xmlns='http://www.w3.org/2001/XMLSchema'
       >
     <annotation>
       <documentation>
         sipX Call State Events
       </documentation>
       <documentation source='http://scm.sipfoundry.org/rep/sipXproxy/main/doc/call-state-events.html'/>
     </annotation>

   <!-- Types -->


     <simpleType name="dns_name">
       <annotation>
         <documentation>
           A DNS name.
         </documentation>
       </annotation>
       <restriction base="normalizedString">
         <pattern value="%dns_token(\.%dns_token)+"/>
       </restriction>
     </simpleType>

     <simpleType name="sip_tag">
       <annotation>
         <documentation>
           This type corresponds to the token 'tag' in RFC 3261 section
           25.1.
         </documentation>
         <documentation source='http://www.rfc-editor.org/rfc/rfc3261.txt'/>
       </annotation>
       <restriction base="normalizedString">
         <pattern value="%sip_token;" />
       </restriction>
     </simpleType>




Lawrence                                                        [Page 5]

                           Call State Events               December 2004


     <simpleType name="sip_call_id">
       <annotation>
         <documentation>
           This type corresponds to the token 'callid' in RFC 3261 section
           25.1.  Note that it does not, by itself, uniquely identify a
           dialog; that is identified by the complete dialog_id type.
         </documentation>
         <documentation source='http://www.rfc-editor.org/rfc/rfc3261.txt'/>
       </annotation>
       <restriction base="normalizedString">
         <pattern value="%sip_word;@%sip_word;" />
       </restriction>
     </simpleType>

     <simpleType name="sip_tofrom_value">
       <annotation>
         <documentation>
         The values allowed in the SIP To or From header fields.
         </documentation>
         <documentation source='http://www.rfc-editor.org/rfc/rfc3261.txt'/>
       </annotation>
       <restriction base="normalizedString"/>
     </simpleType>

     <simpleType name="sip_status">
       <annotation>
         <documentation>
           SIP Status codes
         </documentation>
         <documentation source='http://www.rfc-editor.org/rfc/rfc3261.txt'/>
       </annotation>
       <restriction base="positiveInteger">
         <minInclusive value='100' />
         <maxExclusive value='700' />
       </restriction>
     </simpleType>

     <simpleType name="obs_status_code">
       <annotation>
         <documentation>
           CSE Observer status
         </documentation>
       </annotation>
       <restriction base="positiveInteger">
         <enumeration value='101'>
           <annotation>
             <documentation>Observer Startup</documentation>
           </annotation>



Lawrence                                                        [Page 6]

                           Call State Events               December 2004


         </enumeration>
       </restriction>
     </simpleType>


   <!-- Elements -->

     <element name='call_event'>
       <annotation>
         <documentation>
         A single call_event is generated for each event
         seen by a CSE Observer.  They are sent to a CSE Collector, whose
         reponsibilty is to store and make available the information from a
         set of CSE Observers.
         </documentation>
       </annotation>
       <complexType>
         <sequence>
             <element ref='cse:observer'/>
             <element ref='cse:obs_seq'/>
             <element ref='cse:obs_time'/>
             <choice>
               <element ref='cse:obs_msg'/>
               <element ref='cse:call_request'/>
               <element ref='cse:call_setup'/>
               <element ref='cse:call_failure'/>
               <element ref='cse:call_end'/>
             </choice>
         </sequence>
       </complexType>
     </element>

     <element name='obs_msg'>
       <annotation>
         <documentation>
         This element conveys information about the state of an
         observer.
         </documentation>
       </annotation>
       <complexType>
         <sequence>
             <element ref='cse:obs_status'/>
             <element ref='cse:obs_text' minOccurs='0'/>
         </sequence>
       </complexType>
     </element>

     <element name='obs_status' type='cse:obs_status_code'/>



Lawrence                                                        [Page 7]

                           Call State Events               December 2004


     <element name='obs_text' type='normalizedString'/>

     <element name='call_request'>
       <annotation>
         <documentation>
         This identifies a call attempt.
         The contact in this event is the calling party.
         </documentation>
       </annotation>
       <complexType>
         <sequence>
             <element ref='cse:call'/>
             <element ref='cse:contact'/>
             <element ref='cse:via' maxOccurs='unbounded'/>
         </sequence>
       </complexType>
     </element>

     <element name='call_setup'>
       <annotation>
         <documentation>
         This identifies a successful call completion.
         The contact in this event is the called party.
         </documentation>
       </annotation>
       <complexType>
         <sequence>
             <element ref='cse:call'/>
             <element ref='cse:contact'/>
             <element ref='cse:via' maxOccurs='unbounded'/>
         </sequence>
       </complexType>
     </element>

     <element name='call_end'>
       <annotation>
         <documentation>

         </documentation>
       </annotation>
       <complexType>
         <sequence>
             <element ref='cse:call'/>
             <element ref='cse:via' maxOccurs='unbounded'/>
         </sequence>
       </complexType>
     </element>




Lawrence                                                        [Page 8]

                           Call State Events               December 2004


     <element name='call_failure'>
       <annotation>
         <documentation>

         </documentation>
       </annotation>
       <complexType>
         <sequence>
             <element ref='cse:call'/>
             <element ref='cse:response'/>
             <element ref='cse:via' maxOccurs='unbounded'/>
         </sequence>
       </complexType>
     </element>

     <element name='call'>
       <complexType>
         <sequence>
             <element ref='cse:dialog'/>
             <element ref='cse:to'/>
             <element ref='cse:from'/>
         </sequence>
       </complexType>
     </element>

     <element name='dialog'>
       <annotation>
         <documentation>
         This uniquely identifies a call.
         </documentation>
       </annotation>
       <complexType>
         <sequence>
             <element ref='cse:call_id'/>
             <element ref='cse:from_tag' minOccurs='0'/>
             <element ref='cse:to_tag' minOccurs='0'/>
         </sequence>
       </complexType>
     </element>

     <element name='observer' type='cse:dns_name'>
       <annotation>
         <documentation>
         The DNS name of the commserver host that observed this event.
         </documentation>
       </annotation>
     </element>




Lawrence                                                        [Page 9]

                           Call State Events               December 2004


     <element name='obs_seq' type='unsignedLong'/>

     <element name='obs_time' type='dateTime'/>

     <element name='call_id' type='cse:sip_call_id' />

     <element name='from_tag' type='cse:sip_tag' />

     <element name='to_tag' type='cse:sip_tag' />

     <element name='from' type='cse:sip_tofrom_value' />

     <element name='to' type='cse:sip_tofrom_value' />

     <element name='response'>
       <complexType>
         <sequence>
             <element ref='cse:status'/>
             <element ref='cse:reason'/>
         </sequence>
       </complexType>
     </element>

     <element name='status' type='cse:sip_status'/>

     <element name='reason' type='normalizedString'/>

     <element name='via' type='normalizedString'/>

   </schema>




Author's Address

   Scott Lawrence
   Pingtel Corp.

   EMail: slawrence@pingtel.com

Appendix A.  Example Call State Events


   <call_event xmlns='http://www.sipfoundry.org/sipX/schema/xml/cse-01-00'>
     <observer>out1.sipxchange.example.com</observer>
     <obs_seq>0</obs_seq>
     <obs_time>2003-08-15T17:22.090Z</obs_time>



Lawrence                                                       [Page 10]

                           Call State Events               December 2004


     <obs_msg>
       <obs_status>0</obs_status>
       <obs_text>Observer Restart</obs_text>
     </obs_msg>
   </call_event>

   <call_event xmlns='http://www.sipfoundry.org/sipX/schema/xml/cse-01-00'>
     <observer>out1.sipxchange.example.com</observer>
     <obs_seq>288</obs_seq>
     <obs_time>2003-08-15T17:24.085Z</obs_time>
     <call_request>
       <call>
         <dialog>
           <call_id>call-1063657885-12@10.1.1.252</call_id>
           <from_tag>1c954235820</from_tag>
           <to_tag></to_tag>
         </dialog>
         <from>"Scott"&lt;sip:scott-ix@kathmandu.example.com&gt;;tag=1c954235820</from>
         <to>Some Phone&lt;sip:162@example.com&gt;;transport=tcp</to>
       </call>
       <contact>&lt;sip:scott-ix@10.1.1.252:9999&gt;</contact>
       <via>SIP/2.0/TCP 10.5.6.6;branch=z9hG4bK687e5283dc2bac23258891f6502534a4</via>
     </call_start>
   </call_event>

   <call_event xmlns='http://www.sipfoundry.org/sipX/schema/xml/cse-01-00'>
     <observer>out1.sipxchange.example.com</observer>
     <obs_seq>288</obs_seq>
     <obs_time>2003-08-15T17:25.023Z</obs_time>
     <call_setup>
       <call>
         <dialog>
           <call_id>call-1063657885-12@10.1.1.252</call_id>
           <from_tag>1c954235820</from_tag>
           <to_tag>c1592453082</to_tag>
         </dialog>
         <from>"Scott"&lt;sip:scott-ix@kathmandu.example.com&gt;;tag=1c954235820</from>
         <to>Some Phone&lt;sip:162@example.com&gt;;tag=c1592453082,transport=tcp</to>
       </call>
       <contact>&lt;sip:scott-ix@10.1.1.166:5060&gt;</contact>
       <via>SIP/2.0/TCP 10.5.6.6;branch=z9hG4bK687e5283dc2bac232577f1f6502534a4</via>
     </call_setup>
   </call_event>

   <call_event xmlns='http://www.sipfoundry.org/sipX/schema/xml/cse-01-00'>
     <observer>out1.sipxchange.example.com</observer>
     <obs_seq>290</obs_seq>
     <obs_time>2003-08-15T17:27.023Z</obs_time>



Lawrence                                                       [Page 11]

                           Call State Events               December 2004


     <call_failure>
       <call>
         <dialog>
           <call_id>call-1036576858-13@10.1.1.252</call_id>
           <from_tag>1c954235820</from_tag>
         </dialog>
         <from>"Scott"&lt;sip:scott-ix@kathmandu.example.com&gt;;tag=1c954235820</from>
         <to>Some Phone&lt;sip:162@example.com&gt;transport=tcp</to>
       </call>
       <response>
         <status>403</status>
         <reason>Permission Denied</reason>
       </response>
       <via>SIP/2.0/TCP 10.5.6.6;branch=z9hG4bK687e5283dc2bac232577f1f654444444</via>
     </call_failure>
   </call_event>

   <call_event xmlns='http://www.sipfoundry.org/sipX/schema/xml/cse-01-00'>
     <observer>out1.sipxchange.example.com</observer>
     <obs_seq>312</obs_seq>
     <obs_time>2003-08-15T17:45.023Z</obs_time>
     <call_end>
       <call>
         <dialog>
           <call_id>call-1063657885-12@10.1.1.252</call_id>
           <from_tag>1c954235820</from_tag>
           <to_tag>c1592453082</to_tag>
         </dialog>
         <from>"Scott"&lt;sip:scott-ix@kathmandu.example.com&gt;;tag=1c954235820</from>
         <to>Some Phone&lt;sip:162@example.com&gt;;tag=c1592453082,transport=tcp</to>
       </call>
       <via>SIP/2.0/TCP 10.5.6.6;branch=z9hG4bK687e5283dc2bac232577f1f659999999</via>
     </call_end>
   </call_event>

















Lawrence                                                       [Page 12]

